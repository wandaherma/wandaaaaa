<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator dengan Riwayat</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#c3c8cf;--muted:#94a3b8;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,system-ui,Arial;background:linear-gradient(180deg,#8fa0d3 0%, #bdbfc3 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{display:grid;grid-template-columns:360px 280px;gap:20px;align-items:start}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);min-height:120px}
    .calc{width:100%}
    .display{background:var(--glass);padding:14px;border-radius:10px;min-height:64px;display:flex;flex-direction:column;justify-content:center;overflow:hidden}
    .expr{font-size:14px;color:var(--muted);min-height:20px;word-break:break-all}
    .result{font-size:28px;font-weight:600;line-height:1;color:white;text-align:right}
    .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    button.key{padding:14px;border-radius:10px;border:0;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));color:inherit;font-size:18px;cursor:pointer}
    button.key.op{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    button.key.equal{grid-column:span 2;background:var(--accent);color:#ab2853;font-weight:700}
    .hist{max-height:520px;overflow:auto}
    .hist h3{margin:0 0 8px 0;font-size:16px}
    .entry{padding:10px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);font-size:14px}
    .entry .small{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;margin-bottom:10px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}
    .btn.danger{border-color:#ef4444;color:#fecaca}
    @media (max-width:760px){.wrap{grid-template-columns:1fr;}.hist{max-height:260px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card calc">
      <div class="display" id="display">
        <div class="expr" id="expression">0</div>
        <div class="result" id="result">0</div>
      </div>

      <div class="keys" role="group" aria-label="kalkulator">
        <button class="key" data-val="7">7</button>
        <button class="key" data-val="8">8</button>
        <button class="key" data-val="9">9</button>
        <button class="key op" data-val="/">÷</button>

        <button class="key" data-val="4">4</button>
        <button class="key" data-val="5">5</button>
        <button class="key" data-val="6">6</button>
        <button class="key op" data-val="*">×</button>

        <button class="key" data-val="1">1</button>
        <button class="key" data-val="2">2</button>
        <button class="key" data-val="3">3</button>
        <button class="key op" data-val="-">−</button>

        <button class="key" data-val="0">0</button>
        <button class="key" data-val=".">.</button>
        <button class="key" id="btn-del">DEL</button>
        <button class="key op" data-val="+">+</button>

        <button class="key" id="btn-paren">( )</button>
        <button class="key" data-val="%">%</button>
        <button class="key" id="btn-clear">C</button>
        <button class="key equal" id="btn-eq">=</button>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <button class="btn" id="btn-copy">Salin Hasil</button>
        <button class="btn" id="btn-clear-history">Hapus Riwayat</button>
      </div>
      <div class="hist" id="history">
        <h3>Riwayat Perhitungan</h3>
        <div id="entries"></div>
      </div>
    </div>
  </div>

  <script>
    // Element refs
    const exprEl = document.getElementById('expression');
    const resEl = document.getElementById('result');
    const entriesEl = document.getElementById('entries');

    // State
    let expr = '';
    let lastParenOpen = false;

    // Load history from localStorage
    const STORAGE_KEY = 'calc_history_v1';
    function loadHistory(){
      try{const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw): [];}catch(e){return []}
    }
    function saveHistory(h){ localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); }
    let history = loadHistory();

    function render(){
      exprEl.textContent = expr || '0';
      try{
        const evaluated = expr && expr !== '%' ? evaluateExpression(expr) : '';
        resEl.textContent = evaluated === '' ? '0' : String(evaluated);
      }catch(e){ resEl.textContent = '' }
      renderHistory();
    }

    function renderHistory(){
      entriesEl.innerHTML = '';
      if(history.length === 0){entriesEl.innerHTML = '<div class="entry small">Belum ada riwayat.</div>'; return}
      // latest first
      [...history].reverse().forEach(h =>{
        const el = document.createElement('div'); el.className='entry';
        el.innerHTML = `<div><strong>${escapeHtml(h.expr)}</strong> = <span style="float:right">${escapeHtml(String(h.result))}</span></div>
                        <div class="small">${new Date(h.time).toLocaleString()}</div>`;
        entriesEl.appendChild(el);
      })
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function pushToHistory(expression, result){
      history.push({expr: expression, result: result, time: Date.now()});
      // cap history length
      if(history.length > 200) history = history.slice(history.length - 200);
      saveHistory(history);
      renderHistory();
    }

    // Evaluate safely
    function evaluateExpression(input){
      // Normalize: replace ÷ × − with JS operators and handle percentage
      let s = String(input).replace(/÷/g,'/').replace(/×/g,'*').replace(/−/g,'-');
      // Support percent: convert '50%' => '(50/100)'
      s = s.replace(/(\d+(?:\.\d+)?)%/g, '($1/100)');
      // Disallow letters
      if(/[a-zA-Z]/.test(s)) throw new Error('Invalid');
      // Evaluate using Function constructor
      // eslint-disable-next-line no-new-func
      const fn = new Function('return ('+s+')');
      const val = fn();
      if(typeof val === 'number' && isFinite(val)){
        // Round to 12 significant digits to avoid long floats
        return Math.round((val + Number.EPSILON) * 1e12)/1e12;
      }
      throw new Error('Invalid result');
    }

    // Button handling
    document.querySelectorAll('button.key[data-val]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v = btn.dataset.val;
        insertValue(v);
      })
    });
    document.getElementById('btn-clear').addEventListener('click', ()=>{ expr=''; render(); });
    document.getElementById('btn-del').addEventListener('click', ()=>{ expr = expr.slice(0,-1); render(); });

    document.getElementById('btn-paren').addEventListener('click', ()=>{
      // smart paren: insert '(' or ')' depending
      const openCount = (expr.match(/\(/g)||[]).length;
      const closeCount = (expr.match(/\)/g)||[]).length;
      if(openCount === closeCount || expr.slice(-1).match(/[+\-*/(]/)){
        expr += '(';
      } else {
        expr += ')';
      }
      render();
    });

    document.getElementById('btn-eq').addEventListener('click', ()=>{
      try{
        const result = evaluateExpression(expr || '0');
        pushToHistory(expr || '0', result);
        expr = String(result);
        render();
      }catch(e){ resEl.textContent='Error' }
    });

    // Copy result
    document.getElementById('btn-copy').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(resEl.textContent); alert('Hasil disalin: '+resEl.textContent); }catch(e){ alert('Gagal menyalin') }
    });

    // Clear history
    document.getElementById('btn-clear-history').addEventListener('click', ()=>{
      if(!confirm('Hapus semua riwayat?')) return;
      history = []; saveHistory(history); renderHistory();
    });

    // Keyboard support
    window.addEventListener('keydown', (e)=>{
      if(e.key >= '0' && e.key <= '9') return insertValue(e.key);
      if(['+','-','*','/','(',')','.','%'].includes(e.key)) return insertValue(e.key);
      if(e.key === 'Enter') { e.preventDefault(); document.getElementById('btn-eq').click(); }
      if(e.key === 'Backspace') { expr = expr.slice(0,-1); render(); }
      if(e.key.toLowerCase() === 'c' && (e.ctrlKey || e.metaKey)){ // Ctrl/Cmd + C to copy
        e.preventDefault(); document.getElementById('btn-copy').click();
      }
    });

    function insertValue(v){
      // avoid two operators in a row (except minus for negative numbers)
      const last = expr.slice(-1);
      if(['+','-','*','/','%','.'].includes(v) && expr === ''){
        if(v === '-') { expr = '-'; render(); return; } else return;
      }
      if(['+','','/'].includes(v) && ['+','-','','/','.',''].includes(last)) return;
      if(v === '.' && /\.[0-9]*$/.test(expr)) return; // prevent multiple decimals in current number
      expr += v;
      render();
    }

    // initial render
    render();
  </script>
</body>
</html>
